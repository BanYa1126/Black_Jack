<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            position: relative;
        }

        h1 {
            position: absolute;
            top: 10px;
            text-align: center;
            margin: 0;
            width: 100%;
        }

        #dealer {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: absolute;
            top: 60px;
        }

        #player {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: absolute;
            bottom: 100px;
        }

        #player h2 {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .card {
            width: 100px;
            height: 140px;
            margin: 5px;
        }

        #bet-display {
            position: absolute;
            bottom: 300px;
            font-size: 20px;
            text-align: center;
            width: 100%;
        }

        #result-text {
            position: absolute;
            top: 350px;
            font-size: 24px;
            text-align: center;
            width: 100%;
        }

        #coin-container {
            position: absolute;
            left: 20px;
            bottom: 80px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .coin-stack {
            display: flex;
            flex-direction: column-reverse;
            /* 아래쪽에서 위쪽으로 쌓이도록 설정 */
            align-items: center;
            gap: 2px;
        }

        .coin {
            width: 50px;
            cursor: pointer;
        }

        #reset-bet-btn {
            position: absolute;
            left: 20px;
            bottom: 20px;
        }

        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #2980b9;
        }
    </style>
</head>

<body>
    <h1>Blackjack Game</h1>

    <div id="dealer">
        <h2>Dealer</h2>
        <div id="dealer-cards"></div>
    </div>

    <div id="player">
        <h2>Player - $<span id="player-money"></span></h2>
        <div id="player-cards"></div>
    </div>

    <div id="bet-display">Current Bet: $<span id="current-bet">0</span></div>
    <div id="result-text"></div>

    <div id="controls">
        <button id="hit-btn" onclick="hit()">Hit</button>
        <button id="stay-btn" onclick="stay()">Stay</button>
        <button id="double-btn" onclick="doubleDown()">Double Down</button>
        <button id="surrender-btn" onclick="surrender()">Surrender</button>
    </div>

    <!-- 코인 배치 영역 -->
    <div id="coin-container"></div>
    <button id="reset-bet-btn" onclick="resetBet()">Reset Bet</button>

    <script>
        const cardBacks = [
            "Back/Back_Side0.png",
            "Back/Back_Side1.png",
            "Back/Back_Side2.png",
            "Back/Back_Side3.png",
            "Back/Back_Side4.png",
            "Back/Back_Side5.png",
            "Back/Back_Side6.png",
            "Back/Back_Side7.png"
        ];
        let cardBack;
        let dealerCards = [];
        let playerCards = [];
        let playerMoney = Math.floor(Math.random() * 9000) + 1000;
        let betAmount = 0;
        let decks = [];
        let gameCount = 0;
        let currentDeckIndex = 0;
        let currentDeck = [];
        const coinValues = [10000, 5000, 1000, 500, 100, 50, 10, 5, 1];

        // 코인 배치 함수
        function updateCoinDisplay() {
            const coinContainer = document.getElementById('coin-container');
            coinContainer.innerHTML = '';

            // 플레이어 돈에 따라 코인 표시
            let remainingMoney = playerMoney;

            coinValues.forEach(value => {
                const count = Math.floor(remainingMoney / value);
                if (count > 0) {
                    const coinStack = document.createElement('div');
                    coinStack.classList.add('coin-stack');

                    // 해당 코인 수만큼 이미지 추가
                    for (let i = 0; i < count; i++) {
                        const coin = document.createElement('img');
                        coin.src = `coins/${value}.png`;
                        coin.alt = `${value} Coin`;
                        coin.classList.add('coin');
                        coin.onclick = () => placeBet(value);
                        coinStack.appendChild(coin);
                    }

                    coinContainer.appendChild(coinStack);
                    remainingMoney -= count * value;
                }
            });
        }

        function resetBet() {
            playerMoney += betAmount; // 베팅한 금액을 플레이어에게 반환
            betAmount = 0; // 베팅 금액 초기화
            initializeCoinCounts(); // 코인의 개수를 초기 상태로 복원
            updatePlayerMoney(); // 플레이어 금액 업데이트
            document.getElementById('current-bet').textContent = betAmount; // 화면에 베팅 금액 0으로 표시
            updateCoinDisplay(); // 코인 이미지 업데이트
        }

        function updatePlayerMoney() {
            document.getElementById('player-money').textContent = playerMoney;
            updateCoinDisplay(); // 코인 업데이트
        }

        function placeBet(amount) {
            if (playerMoney >= amount) {
                betAmount += amount;
                playerMoney -= amount;
                updateCoinDisplay();
                updateCoinDisplay();
                document.getElementById('current-bet').textContent = betAmount;
            } else {
                alert('Not enough money to place this bet!');
            }
        }

        function initializeCoinCounts() {
            coinCounts = {};
            let remainingMoney = playerMoney;
            coinValues.forEach(value => {
                coinCounts[value] = Math.floor(remainingMoney / value);
                remainingMoney %= value;
            });
            updateCoinDisplay();
        }

        // 카드 덱 생성 및 섞기
        function createDecks() {
            const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
            const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const numberOfDecks = Math.floor(Math.random() * 5) + 4;  // 4~8개의 덱 생성
            decks = [];

            // 각 덱 생성
            for (let i = 0; i < numberOfDecks; i++) {
                const deck = [];
                for (let suit of suits) {
                    for (let value of values) {
                        deck.push({ value, suit, img: `cards/${value}_of_${suit}.png` });
                    }
                }
                decks.push(deck);  // 덱 배열에 각 덱 추가
            }

            shuffleDecks();
            setCurrentDeck();  // 처음 사용할 덱 설정
        }

        // 카드 덱 섞기
        function shuffleDecks() {
            decks.forEach(deck => {
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }
            });
        }

        // 현재 덱 설정 및 덱 변경
        function setCurrentDeck() {
            if (currentDeckIndex >= decks.length) {
                currentDeckIndex = 0;  // 모든 덱을 다 사용했으면 다시 첫 번째 덱으로
            }

            currentDeck = decks[currentDeckIndex];  // 현재 사용할 덱 설정
            cardBack = cardBacks[currentDeckIndex % cardBacks.length];  // 덱의 카드 뒷면 설정
            gameCount = 0;  // 게임 횟수 초기화
        }

        // 게임이 끝날 때 덱 변경 로직 실행
        function endGame() {
            gameCount++;  // 게임 진행 횟수 증가
            if (gameCount >= 5) {  // 5번의 게임이 끝나면 덱을 변경
                currentDeckIndex++;  // 다음 덱으로 이동
                setCurrentDeck();  // 새로운 덱 설정
            }
        }

        // 카드 한 장을 뽑는 로직 (게임 중 사용)
        function drawCard() {
            if (currentDeck.length === 0) {  // 덱에 카드가 없으면 다음 덱으로
                currentDeckIndex++;
                setCurrentDeck();
            }
            const card = currentDeck.pop();  // 현재 덱에서 카드 뽑기
            return card;
        }

        // 게임이 종료되었을 때 실행될 함수 (딜러와 플레이어 모두의 승패 결정 후 호출)
        function gameResult() {
            // 게임 결과 로직 처리
            endGame();  // 게임 종료 후 덱 변경 체크
            betAmount = 0
            document.getElementById('current-bet').textContent = betAmount;
        }

        // 게임 시작 시 카드 나누기
        function dealCards() {
            dealerCards = [];
            playerCards = [];
            dealerCards.push(drawCard());
            dealerCards.push(drawCard());
            document.getElementById("dealer-cards").innerHTML = `
                <img class="card" src="${dealerCards[0].img}" alt="dealer card">
                <img class="card" src="${cardBack}" alt="dealer card back">
            `;

            playerCards.push(drawCard());
            playerCards.push(drawCard());
            updatePlayerCards();
            checkForBlackjack();
        }

        // 플레이어 카드 화면에 표시
        function updatePlayerCards() {
            const playerCardsDiv = document.getElementById("player-cards");
            playerCardsDiv.innerHTML = "";
            playerCards.forEach(card => {
                playerCardsDiv.innerHTML += `<img class="card" src="${card.img}" alt="player card">`;
            });
        }

        function updateDealerCards() {
            const dealerCardsDiv = document.getElementById("dealer-cards");
            dealerCardsDiv.innerHTML = "";
            dealerCards.forEach(card => {
                dealerCardsDiv.innerHTML += `<img class="card" src="${card.img}" alt="dealer card">`;
            });
        }

        function updatePlayerMoney() {
            document.getElementById('player-money').textContent = playerMoney;
        }

        // 게임 결과를 화면에 표시
        function displayResult(result) {
            document.getElementById('result-text').textContent = result;
        }

        // Hit 버튼: 카드를 한 장 받는 로직
        function hit() {
            playerCards.push(drawCard());
            updatePlayerCards();

            if (calculateHandValue(playerCards) >= 21) {
                stay();
            }
        }

        // Stay 버튼: 딜러의 로직 시작
        function stay() {
            revealDealerCard();
            setTimeout(dealerTurn, 1000);

            // Stay 이후 플레이어의 금액과 코인 상태 업데이트
            updatePlayerMoney();
            updateCoinDisplay(); // 즉시 코인 상태 업데이트
        }

        // Double Down 버튼
        function doubleDown() {
            if (playerMoney >= betAmount) {
                playerMoney -= betAmount; // 플레이어가 더블 다운한 금액 차감
                betAmount *= 2;
                playerCards.push(drawCard());
                updatePlayerCards();
                setTimeout(dealerTurn, 1000);

                // Double Down 이후 플레이어의 금액과 코인 상태 업데이트
                updatePlayerMoney();
                updateCoinDisplay(); // 즉시 코인 상태 업데이트
            } else {
                alert('Not enough money to double down!');
            }
        }

        // Surrender 버튼
        function surrender() {
            playerMoney += betAmount / 2; // 베팅 금액의 절반을 플레이어에게 반환
            betAmount = 0; // 베팅 금액 초기화
            displayResult('Surrender! 베팅 금액의 절반을 돌려받습니다.');
            updatePlayerMoney();
            updateCoinDisplay(); // 즉시 코인 상태 업데이트
            dealCards(); // 새로운 카드 배분으로 게임 재시작
        }


        // 딜러의 두 번째 카드 공개
        function revealDealerCard() {
            updateDealerCards();
        }

        // 딜러의 규칙에 따른 카드 받기
        function dealerTurn() {
            let dealerValue = calculateHandValue(dealerCards);

            function drawDealerCard() {
                if (dealerValue < 17) {
                    dealerCards.push(drawCard());
                    updateDealerCards();
                    dealerValue = calculateHandValue(dealerCards);
                    setTimeout(drawDealerCard, 1000); // 다음 카드를 받을 때까지 1초 딜레이
                } else {
                    determineWinner();
                }
            }

            drawDealerCard();
        }

        // 손 패의 총합 계산
        function calculateHandValue(cards) {
            let value = 0;
            let aceCount = 0;

            cards.forEach(card => {
                if (card.value === 'A') {
                    aceCount++;
                    value += 11;
                } else if (['J', 'Q', 'K'].includes(card.value)) {
                    value += 10;
                } else {
                    value += parseInt(card.value);
                }
            });

            while (value > 21 && aceCount > 0) {
                value -= 10;
                aceCount--;
            }

            return value;
        }

        // 블랙잭 체크
        function checkForBlackjack() {
            const playerValue = calculateHandValue(playerCards);
            const dealerValue = calculateHandValue(dealerCards);

            if (playerValue === 21 && dealerValue === 21) {
                revealDealerCard();
                displayResult("Both have blackjack! It's a tie.");
                dealCards();
            } else if (playerValue === 21) {
                displayResult("Player has blackjack! Player wins!");
                playerMoney += betAmount * 2.5;
                updatePlayerMoney();
                dealCards();
            } else if (dealerValue === 21) {
                revealDealerCard();
                displayResult("Dealer has blackjack! Dealer wins.");
                playerMoney -= 1.5 * betAmount;
                updatePlayerMoney();
                dealCards();
            }
        }

        // 승패 결정 및 결과 표시
        function determineWinner() {
            const playerValue = calculateHandValue(playerCards);
            const dealerValue = calculateHandValue(dealerCards);
            let resultMessage = '';

            if (playerValue > 21) {
                playerMoney -= betAmount;
                resultMessage = 'Player busts! Dealer wins.';
            } else if (dealerValue > 21) {
                playerMoney += 2 * betAmount;
                resultMessage = 'Dealer busts! Player wins.';
            } else if (playerValue > dealerValue) {
                playerMoney += 2 * betAmount;
                resultMessage = 'Player wins!';
            } else if (playerValue < dealerValue) {
                playerMoney -= betAmount;
                resultMessage = 'Dealer wins!';
            } else {
                resultMessage = "It's a tie!";
            }

            updatePlayerMoney();
            displayResult(resultMessage);
            gameResult();  // 게임 결과 후에 게임 종료 처리
            dealCards();  // 새로운 게임 시작
        }

        // 페이지 로드 시 게임 시작
        window.onload = function () {
            createDecks();
            dealCards();
            updateCoinDisplay();
        }
    </script>
</body>

</html>